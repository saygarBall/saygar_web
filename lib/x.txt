#app.py
from flask import Flask, render_template, request, redirect, url_for, session, flash
from lib.database import load_data, get_db_connection
from lib.home import home_bp
from lib.service import service_bp
from lib.content import content_bp
from lib.search import search_bp
import sqlite3
from werkzeug.security import check_password_hash
from werkzeug.utils import secure_filename
from lib.posts import handle_post, get_posts, get_latest_posts, create_service_folder, get_post_images
from lib.database2 import get_db, init_db, setup_app, get_user, update_user_rank, update_user_rank_by_email
from lib.auth import register_user, authenticate_user
from lib.user_management import promote_user_to_admin, demote_user_to_default, get_all_users
from lib.post_actions import *
from lib.service_centers import get_service_name, get_all_service_centers, get_service_intro
from lib.accounts import account_blueprint
from lib.utils import allowed_file, check_user_rank, create_folder_if_not_exists, save_image, get_greeting, sanitize_filename
import os
from lib.auth import check_user_permission



app = Flask(__name__)
app.secret_key = 'arkarachaicojwlkasdic84ljJIJOfjwkja9c5553'
app.register_blueprint(account_blueprint)



app.register_blueprint(home_bp)
app.register_blueprint(service_bp)
app.register_blueprint(content_bp)
app.register_blueprint(search_bp)

@app.route('/index2')
def index2():
    greeting = get_greeting()
    user = get_user(session['user_id']) if 'user_id' in session else None
    
    service_centers = get_all_service_centers()
    latest_posts = get_latest_posts()

    # ‡πÉ‡∏ä‡πâ get_post_images ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    post_images = {post['title']: get_post_images(post['title']) for post in latest_posts}

    return render_template('index2.html', greeting=greeting, user=user, service_centers=service_centers, latest_posts=latest_posts, post_images=post_images)

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        form_data = request.form
        profile_picture = request.files['profile_picture']
        register_user(form_data, profile_picture)
        return redirect(url_for('login'))
    
    return render_template('register.html')

@app.route('/manage_users')
@check_user_permission('user_administrator_and_manage_systems')
def manage_users():
    users = get_all_users()
    return render_template('manage_users.html', users=users)

@app.route('/user_details/<int:id>', methods=['GET', 'POST'])
@check_user_permission('user_administrator_and_manage_systems')
def user_details(id):
    user = get_user(id)
    if request.method == 'POST':
        new_rank = request.form.get('rank')
        if new_rank in ['user_default', 'user_admin']:
            update_user_rank(id, new_rank)
            flash('‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
            return redirect(url_for('manage_users'))
    return render_template('user_details.html', user=user)

@app.route('/change_user_rank/<int:id>', methods=['POST'])
def change_user_rank(id):
    if 'user_id' in session and session.get('user_id'):
        user_id = session['user_id']
        user = get_user(user_id)
        if user['rank'] == 'user_administrator_and_manage_systems':
            new_rank = request.form['rank']
            update_user_rank(id, new_rank)
            flash('‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß')
        else:
            flash('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')
    else:
        flash('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô')
    return redirect(url_for('manage_users'))

@app.route('/account')
def account():
    user = get_user(session['user_id']) if 'user_id' in session else None
    return render_template('account.html', user=user)

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        email = request.form['email']
        password = request.form['password']

        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()

        if user and check_password_hash(user['password'], password):
            session['user_id'] = user['id']
            session['email'] = user['email']
            session.permanent = True
            return redirect(url_for('home.home'))
        else:
            flash('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
            return redirect(url_for('login'))
    return render_template('login.html')

@app.route('/logout')
def logout():
    session.clear()  # ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    flash('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
    return redirect(url_for('home.home'))

@app.route('/promote_user/<int:id>')
def promote_user(id):
    if 'user_id' in session and session.get('user_id'):
        user_id = session['user_id']
        db = get_db()
        current_user = db.execute("SELECT * FROM users WHERE id = ?", (user_id,)).fetchone()
        if current_user['rank'] == 'user_administrator_and_manage_systems':
            db.execute("UPDATE users SET rank = 'user_admin' WHERE id = ?", (id,))
            db.commit()
            flash('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
            return redirect(url_for('manage_users'))
        else:
            flash('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')
            return redirect(url_for('index2'))
    return redirect(url_for('login'))

@app.route('/demote_user/<int:id>')
@check_user_permission('user_administrator_and_manage_systems')
def demote_user(id):
    update_user_rank(id, 'user_default')
    flash('‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
    return redirect(url_for('manage_users'))

@app.route('/post_service_center/<int:service_id>', methods=['GET', 'POST'])
def post_service_center(service_id):
    if request.method == 'POST':
        title = request.form.get('title')
        content = request.form.get('content')
        images = request.files.getlist('image')

        post_folder = os.path.join(app.root_path, 'static', 'uploads', secure_filename(title))
        create_folder_if_not_exists(post_folder)

        saved_image_names = [save_image(image, post_folder) for image in images if image and allowed_file(image.filename)]

        # Check if user is logged in
        if 'user_id' in session and session.get('user_id'):
            user = get_user(session['user_id'])
            firstname, lastname, user_rank, email = user['firstname'], user['lastname'], user['rank'], user['email']
        else:
            flash("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏î‡πâ")
            return redirect(url_for('login'))

        handle_post(service_id, title, content, saved_image_names, firstname, lastname, user_rank, email)
        flash('‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!')
        return redirect(url_for('service_center', service_id=service_id))

    flash('Method ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
    return redirect(url_for('index2'))


@app.route('/post_actions/<int:service_id>/<post_title>', methods=['GET', 'POST'])
def post_actions(service_id, post_title):
    post_owner_email = get_post_owner_email(service_id, post_title)
    post_content, comments = get_post_and_comments(service_id, post_title, post_owner_email)
    like_count, dislike_count = get_post_like_counts(service_id, post_title)


    # Fetch images attached to the post
    post_images = get_post_images(post_title)

    user = get_user(session['user_id']) if 'user_id' in session else None
    is_owner = user and user['email'] == post_owner_email

    post_owner = get_user(post_owner_email, by_email=True)
    post_owner_profile_picture = post_owner['profile_picture'] if post_owner else 'default_profile.png'

    if request.method == 'POST' and 'comment' in request.form:
        if user:
            comment_content = request.form['comment']
            save_comment(service_id, post_title, comment_content, user['firstname'], user['lastname'], user['email'], post_owner_email)
            flash('‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!')
        else:
            flash("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ")
        return redirect(request.url)

    return render_template(
        'post_actions.html', 
        post_title=post_title, 
        post_content=post_content, 
        comments=comments, 
        is_owner=is_owner,
        service_id=service_id, 
        user=user,
        post_owner_profile_picture=post_owner_profile_picture,
        post_images=post_images,
        like_count=like_count,
        dislike_count=dislike_count
    )

@app.route('/delete_post/<int:service_id>/<post_title>', methods=['POST'])
def delete_post(service_id, post_title):
    if 'user_id' in session and session.get('user_id'):
        user_id = session['user_id']
        user = get_user(user_id)
        if check_post_owner(service_id, post_title, user['email']):
            post_folder = create_service_folder(service_id, user['email'])
            post_filepath = os.path.join(post_folder, f"{post_title}.txt")

            if os.path.exists(post_filepath):
                os.remove(post_filepath)
                flash("‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
            else:
                flash("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö")

            return redirect(url_for('service_center', service_id=service_id))
        else:
            flash("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ")
    return redirect(url_for('service_center', service_id=service_id))

@app.route('/edit_post/<int:service_id>/<post_title>', methods=['GET', 'POST'])
def edit_post(service_id, post_title):
    if 'user_id' in session and session.get('user_id'):
        user_id = session['user_id']
        user = get_user(user_id)

        if check_post_owner(service_id, post_title, user['email']):
            post_folder = create_service_folder(service_id, user['email'])
            post_filepath = os.path.join(post_folder, f"{post_title}.txt")

            # ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° newline ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            post_content = read_post_content(post_filepath).strip()

            if request.method == 'POST':
                new_content = request.form['new_content'].strip().replace("\r\n", "\n")  # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ newline ‡πÉ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
                
                # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå
                with open(post_filepath, 'w', encoding='utf-8') as f:
                    f.write(f"‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢: {user['firstname']} {user['lastname']} ({user['rank']})\n")
                    f.write(f"‡πÄ‡∏ß‡∏•‡∏≤: {datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-4]}\n\n")
                    f.write("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n")
                    f.write(new_content)  # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ newline

                flash("‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
                return redirect(url_for('post_actions', service_id=service_id, post_title=post_title))

            return render_template('edit_post.html', post_title=post_title, post_content=post_content)
        else:
            flash("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ")
    return redirect(url_for('service_center', service_id=service_id))

@app.route('/edit_comment/<int:service_id>/<post_title>/<comment_time>', methods=['POST'])
def edit_comment(service_id, post_title, comment_time):
    if 'user_id' in session and session.get('user_id'):
        user_id = session['user_id']
        user = get_user(user_id)

        post_owner_email = get_post_owner_email(service_id, post_title)
        post_content, comments = get_post_and_comments(service_id, post_title, post_owner_email)

        new_content = request.form['new_content']

        comment_filepath = os.path.join('txt', get_service_name(service_id), post_owner_email, f"{post_title}_comment.txt")
        updated_comments = []
        
        with open(comment_filepath, 'r', encoding='utf-8') as f:
            for line in f.readlines():
                parsed = line.strip().split(':', 2)
                if len(parsed) == 3 and parsed[2] == comment_time and parsed[0] == f"{user['firstname']} {user['lastname']}":
                    updated_comments.append(f"{parsed[0]}:{new_content}:{parsed[2]}\n")
                else:
                    updated_comments.append(line)

        with open(comment_filepath, 'w', encoding='utf-8') as f:
            f.writelines(updated_comments)

        flash('‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
        return redirect(url_for('post_actions', service_id=service_id, post_title=post_title))

    flash('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ')
    return redirect(url_for('login'))

@app.route('/delete_comment/<int:service_id>/<post_title>/<comment_time>', methods=['POST'])
def delete_comment(service_id, post_title, comment_time):
    if 'user_id' in session and session.get('user_id'):
        user_id = session['user_id']
        user = get_user(user_id)

        post_owner_email = get_post_owner_email(service_id, post_title)
        comment_filepath = os.path.join('txt', get_service_name(service_id), post_owner_email, f"{post_title}_comment.txt")
        updated_comments = []

        with open(comment_filepath, 'r', encoding='utf-8') as f:
            for line in f.readlines():
                parsed = line.strip().split(':', 2)
                if len(parsed) == 3 and parsed[2] == comment_time and parsed[0] == f"{user['firstname']} {user['lastname']}":
                    continue
                updated_comments.append(line)

        with open(comment_filepath, 'w', encoding='utf-8') as f:
            f.writelines(updated_comments)

        flash('‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
        return redirect(url_for('post_actions', service_id=service_id, post_title=post_title))

    flash('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏î‡πâ')
    return redirect(url_for('login'))

@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500

@app.route('/service_center/<int:service_id>')
def service_center(service_id):
    service_name = get_service_name(service_id)
    posts = get_posts(service_id)
    greeting = get_greeting()

    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
    service_intro = get_service_intro(service_name)

    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    post_images = {}
    for post in posts:
        post_folder = os.path.join('static', 'uploads', post['title'])
        if os.path.exists(post_folder):
            post_images[post['title']] = [
                filename for filename in os.listdir(post_folder) if allowed_file(filename)
            ]
        else:
            post_images[post['title']] = []

    user = get_user(session['user_id']) if 'user_id' in session else None
    return render_template(
        'service_center.html', 
        posts=posts, 
        service_name=service_name, 
        service_id=service_id, 
        greeting=greeting, 
        user=user,
        post_images=post_images,  # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
        service_intro=service_intro  # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
    )

@app.route("/admin-dashboard")
def admin_dashboard():
    query = request.args.get("q", "").strip()
    conn = get_db_connection()
    conn.row_factory = sqlite3.Row

    if query:
        rows = conn.execute("SELECT id, title FROM articles WHERE title LIKE ?", (f"%{query}%",)).fetchall()
    else:
        rows = conn.execute("SELECT id, title FROM articles").fetchall()
    conn.close()

    # ‡∏î‡∏∂‡∏á user ‡∏à‡∏≤‡∏Å session ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô base.html
    user = get_user(session['user_id']) if 'user_id' in session else None

    articles = []
    for row in rows:
        filename = f"{sanitize_filename(row['title'])}.mp3"
        exists = os.path.exists(os.path.join("static", "audio", filename))
        articles.append({
            "id": row["id"],
            "title": row["title"],
            "tts_exists": exists
        })

    return render_template("admin_dashboard.html", articles=articles, user=user)

@app.route("/delete-article/<int:article_id>", methods=["POST"])
def delete_article(article_id):
    conn = get_db_connection()
    article = conn.execute("SELECT title FROM articles WHERE id=?", (article_id,)).fetchone()
    if not article:
        return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°", 404

    conn.execute("DELETE FROM articles WHERE id=?", (article_id,))
    conn.commit()
    conn.close()

    # ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢
    from lib.utils import sanitize_filename
    filename = f"{sanitize_filename(article['title'])}.mp3"
    audio_path = os.path.join("static", "audio", filename)
    if os.path.exists(audio_path):
        os.remove(audio_path)

    return redirect(url_for("admin_dashboard"))

from datetime import datetime

@app.route("/admin/add-category", methods=["GET", "POST"])
def add_article():
    conn = get_db_connection()
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    if request.method == "POST":
        title = request.form["title"].strip()
        content = request.form["content"].strip()
        category_id = request.form["category_id"]
        updated_at = datetime.now().isoformat()

        # üëâ 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        cursor.execute("""
            INSERT INTO articles (title, content, category_id, updated_at)
            VALUES (?, ?, ?, ?)
        """, (title, content, category_id, updated_at))
        conn.commit()

        # üëâ 2. ‡∏î‡∏∂‡∏á path ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        cursor.execute("SELECT path FROM categories WHERE id = ?", (category_id,))
        category = cursor.fetchone()
        if category:
            category_path = category["path"]
            folder_path = os.path.join("data_base", category_path)
            os.makedirs(category_path, exist_ok=True)

            # üëâ 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå .txt ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° (sanitize)
            filename = f"{sanitize_filename(title)}.txt"
            file_path = os.path.join(category_path, filename)

            # üëâ 4. ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå .txt
            with open(file_path, "w", encoding="utf-8") as f:
                f.write(content.strip())

        conn.close()
        flash("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success")
        return redirect(url_for("add_article"))

    # üëâ ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ h_)
    cursor.execute("SELECT id, name FROM categories ORDER BY name")
    all_categories = cursor.fetchall()
    categories = [
        (row["id"], row["name"])
        for row in all_categories
        if not row["name"].startswith("h_")
    ]

    conn.close()
    return render_template("add_article.html", categories=categories)

@app.context_processor
def inject_user():
    user = get_user(session['user_id']) if 'user_id' in session else None
    return dict(user=user)

@app.route('/like_post', methods=['POST'])
def like_post_route():
    return like_post()

if __name__ == "__main__":
    load_data()  # ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô
    setup_app(app)
    app.run(debug=True)


#accounts.py
from flask import Blueprint, render_template, redirect, url_for, session, flash, request
from werkzeug.utils import secure_filename
import os
from lib.database2 import get_db  # ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ get_db ‡∏à‡∏≤‡∏Å database.py ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á circular import
from lib.utils import allowed_file  # Import ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≤‡∏Å utils

UPLOAD_FOLDER = 'static/uploads'
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}

account_blueprint = Blueprint('account', __name__)

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)


# Route ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
@account_blueprint.route('/account', methods=['GET'])
def account():
    if 'user_id' in session:
        user_id = session['user_id']
        db = get_db()
        user = db.execute("SELECT * FROM users WHERE id = ?", (user_id,)).fetchone()
        return render_template('account.html', user=user)
    return redirect(url_for('auth.login'))

# Route ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
@account_blueprint.route('/account/edit', methods=['GET', 'POST'])
def edit_account():
    if 'user_id' not in session:
        return redirect(url_for('auth.login'))
    
    user_id = session['user_id']
    db = get_db()
    user = db.execute("SELECT * FROM users WHERE id = ?", (user_id,)).fetchone()

    if request.method == 'POST':
        firstname = request.form['firstname']
        lastname = request.form['lastname']
        email = request.form['email']
        phone = request.form['phone']
        address_permanent = request.form['address_permanent']
        address_current = request.form['address_current']
        dob = request.form['dob']

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        profile_picture = request.files['profile_picture']
        if profile_picture and allowed_file(profile_picture.filename):
            # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
            filename = secure_filename(email.replace('@', '_') + '.' + profile_picture.filename.rsplit('.', 1)[1].lower())
            filepath = os.path.join(UPLOAD_FOLDER, filename)
            profile_picture.save(filepath)
        else:
            # ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
            filename = user['profile_picture']

        # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        db.execute('''
            UPDATE users SET firstname = ?, lastname = ?, email = ?, phone = ?, address_permanent = ?, 
            address_current = ?, dob = ?, profile_picture = ? WHERE id = ?
        ''', (firstname, lastname, email, phone, address_permanent, address_current, dob, filename, user_id))
        db.commit()
        flash('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
        return redirect(url_for('account.account'))
    
    return render_template('edit_account.html', user=user)

#auth.py
from flask import session, redirect, url_for, flash
from werkzeug.security import generate_password_hash, check_password_hash
from lib.database2 import get_db, get_user
from werkzeug.utils import secure_filename
import os
import sqlite3  # ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ sqlite3
from lib.utils import allowed_file  # Import ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≤‡∏Å utils
from functools import wraps

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
def check_user_permission(required_rank):
    def wrapper(func):
        @wraps(func)
        def decorated_view(*args, **kwargs):
            if 'user_id' not in session:
                flash("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô")
                return redirect(url_for('login'))
            user = get_user(session['user_id'])
            if user and user['rank'] == required_rank:
                return func(*args, **kwargs)
            flash("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ")
            return redirect(url_for('home.home'))
        return decorated_view
    return wrapper


# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
UPLOAD_FOLDER = 'static/uploads'
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
def save_profile_picture(profile_picture, email):
    if profile_picture and allowed_file(profile_picture.filename):
        file_extension = profile_picture.filename.rsplit('.', 1)[1].lower()
        filename = secure_filename(f"{email.replace('@', '_')}.{file_extension}")
        filepath = os.path.join('static/uploads', filename)
        profile_picture.save(filepath)
        return filename
    else:
        flash('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó png, jpg, jpeg ‡∏´‡∏£‡∏∑‡∏≠ gif')
        return None

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
def register_user(form_data, profile_picture):
    firstname = form_data['firstname']
    lastname = form_data['lastname']
    email = form_data['email']
    password = generate_password_hash(form_data['password'])
    phone = form_data['phone']  # ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
    address_permanent = form_data['address_permanent']  # ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏≤‡∏ß‡∏£
    address_current = form_data['address_current']  # ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    dob = form_data['dob']  # ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î

    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    profile_filename = save_profile_picture(profile_picture, email)

    db = get_db()
    try:
        # ‡∏ü‡∏¥‡∏•‡∏î‡πå registered_date ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ DEFAULT CURRENT_TIMESTAMP ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        db.execute(
            '''
            INSERT INTO users (firstname, lastname, email, password, phone, address_permanent, address_current, dob, profile_picture) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''',
            (firstname, lastname, email, password, phone, address_permanent, address_current, dob, profile_filename)
        )
        db.commit()

        # ‡πÄ‡∏Å‡πá‡∏ö user_id ‡∏•‡∏á‡πÉ‡∏ô session
        user = db.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()
        session['user_id'] = user['id']
    except sqlite3.IntegrityError:
        flash('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß')

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
def authenticate_user(email, password):
    db = get_db()
    user = db.execute('SELECT * FROM users WHERE email = ?', (email,)).fetchone()

    if user and check_password_hash(user['password'], password):
        session['user_id'] = user['id']
        return True
    else:
        flash('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
        return False

#content.py
from flask import Blueprint, render_template, send_from_directory, request, abort, Response
import os
import sqlite3
from docx import Document
from gtts import gTTS
from lib.database import DB_FILE, get_db_connection
from lib.utils import sanitize_filename

content_bp = Blueprint("content", __name__)
DOWNLOAD_FOLDER = "downloads"
ARTICLE_FOLDER = "articles"
AUDIO_FOLDER = "static/audio"

def get_file_size(file_path):
    if os.path.exists(file_path):
        size = os.path.getsize(file_path) / (1024 * 1024)
        return f"{size:.2f} MB"
    return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå"

def convert_docx_to_html(file_path):
    doc = Document(file_path)
    html_content = ""
    for para in doc.paragraphs:
        text = para.text
        if text.startswith("download_file="):
            filename = text.split("=")[1].strip()
            file_path = os.path.join(DOWNLOAD_FOLDER, filename)
            file_size = get_file_size(file_path)
            download_link = f'<a href="{request.host_url}download/{filename}" class="btn btn-success">üì• Download {filename} ({file_size})</a>'
            html_content += f"<p>{download_link}</p>\n"
        else:
            html_content += f"<p>{text}</p>\n"
    return html_content

@content_bp.route("/download/<filename>")
def download_file(filename):
    file_path = os.path.join(DOWNLOAD_FOLDER, filename)
    if not os.path.exists(file_path):
        abort(404, description="‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå")
    return send_from_directory(DOWNLOAD_FOLDER, filename, as_attachment=True)

@content_bp.route("/content/<int:article_id>")
def content(article_id):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT title, content, category_id FROM articles WHERE id=?", (article_id,))
    article = cursor.fetchone()
    conn.close()

    if not article:
        return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ"

    title, content, category_id = article
    new_content = []
    lines = content.split("\n")
    for line in lines:
        if line.startswith("download_file="):
            filename = line.split("=")[1].strip()
            file_path = os.path.join(DOWNLOAD_FOLDER, filename)
            file_size = get_file_size(file_path)
            file_ext = filename.split(".")[-1].lower()

            if file_ext in ["mp3", "wav", "ogg"]:
                player_html = f'''
                <audio id="{filename}" controls>
                    <source src="{request.host_url}download/{filename}" type="audio/{file_ext}">
                    Your browser does not support the audio tag.
                </audio>
                '''
            elif file_ext in ["mp4", "mov"]:
                player_html = f'''
                <video id="{filename}" width="600" controls>
                    <source src="{request.host_url}download/{filename}" type="video/{file_ext}">
                    Your browser does not support the video tag.
                </video>
                '''
            else:
                player_html = f'<a href="{request.host_url}download/{filename}" class="btn btn-success">üì• Download {filename} ({file_size})</a>'

            new_content.append(player_html)

        elif line.startswith("media_file="):
            filename = line.split("=")[1].strip()
            file_path = os.path.join(ARTICLE_FOLDER, filename)
            file_size = get_file_size(file_path)
            file_ext = filename.split(".")[-1].lower()
            media_url = f"{request.host_url}media/{filename}"

            if file_ext in ["mp3", "wav", "ogg"]:
                player_html = f'''
                <audio id="{filename}" controls>
                    <source src="{media_url}" type="audio/{file_ext}">
                    Your browser does not support the audio tag.
                </audio>
                '''
            elif file_ext in ["mp4", "mov"]:
                player_html = f'''
                <video id="{filename}" width="600" controls>
                    <source src="{media_url}" type="video/{file_ext}">
                    Your browser does not support the video tag.
                </video>
                '''
            else:
                player_html = f'<a href="{media_url}" class="btn btn-success">üì• Download {filename} ({file_size})</a>'

            new_content.append(player_html)
        else:
            new_content.append(line)

    content_html = "<br>".join(new_content)

    # ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á path ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    audio_filename = f"{sanitize_filename(title)}.mp3"
    tts_path = os.path.join(AUDIO_FOLDER, audio_filename)
    tts_url = f"/{tts_path}" if os.path.exists(tts_path) else None

    return render_template("content.html", title=title, content=content_html, category_id=category_id, tts_url=tts_url, article_id=article_id)

@content_bp.route("/tts/<int:article_id>")
def generate_tts(article_id):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT content FROM articles WHERE id=?", (article_id,))
    row = cursor.fetchone()
    conn.close()

    if not row:
        abort(404, description="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ")

    text = row[0]
    tts = gTTS(text=text, lang="th")
    os.makedirs(AUDIO_FOLDER, exist_ok=True)
    audio_filename = f"article_{article_id}.mp3"
    file_path = os.path.join(AUDIO_FOLDER, audio_filename)
    tts.save(file_path)

    return send_from_directory(AUDIO_FOLDER, audio_filename)

@content_bp.route("/media/<filename>")
def media_file(filename):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT category_id FROM articles WHERE content LIKE ?", (f"media_file={filename}",))
    row = cursor.fetchone()
    conn.close()

    if row is None:
        abort(404, description="‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå")

    category_id = row["category_id"]

    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT path FROM categories WHERE id = ?", (category_id,))
    category = cursor.fetchone()
    conn.close()

    if category is None:
        abort(404, description="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà")

    category_path = category["path"]
    file_path = os.path.join(category_path, filename)

    if not os.path.exists(file_path):
        abort(404, description="‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå")

    return send_from_directory(category_path, filename, mimetype="audio/mpeg" if filename.endswith(".mp3") else "video/mp4")

#database.py
import sqlite3
import os
from datetime import datetime
from docx import Document

DB_FILE = "database.db"
DATA_DIR = "data_base"
LOG_FILE = "log.txt"
BATCH_SIZE = 10  # Commit ‡∏ó‡∏∏‡∏Å 10 ‡πÑ‡∏ü‡∏•‡πå
VALID_EXTENSIONS = [".txt", ".docx", ".mp3", ".wav", ".ogg", ".mp4", ".mov"]

def log_message(message):
    """ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á log.txt """
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    with open(LOG_FILE, "a", encoding="utf-8") as log:
        log.write(f"[{timestamp}] {message}\n")

def get_db_connection():
    """ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SQLite """
    try:
        conn = sqlite3.connect(DB_FILE)
        conn.row_factory = sqlite3.Row
        return conn
    except sqlite3.Error as e:
        log_message(f"Database error: {e}")
        return None

def ensure_tables_exist():
    """ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ """
    conn = get_db_connection()
    if conn is None:
        return
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE,
            path TEXT,
            parent_id INTEGER
        )
    """)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS articles (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT,
            content TEXT,
            category_id INTEGER,
            updated_at TEXT,
            UNIQUE(title, category_id)
        )
    """)
    conn.commit()
    conn.close()

def cleanup_deleted_files():
    """ ‡∏•‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï sequence """
    conn = get_db_connection()
    if conn is None:
        return
    cursor = conn.cursor()
    cursor.execute("SELECT id, title, category_id FROM articles")
    articles = cursor.fetchall()
    deleted_articles = []
    for article_id, title, category_id in articles:
        cursor.execute("SELECT path FROM categories WHERE id=?", (category_id,))
        category_path_result = cursor.fetchone()
        if category_path_result:
            category_path = category_path_result["path"]
            file_exists = any(
                os.path.exists(os.path.join(category_path, f"{title}{ext}")) for ext in VALID_EXTENSIONS
            )
            if not file_exists:
                log_message(f"üõë ‡∏•‡∏ö‡∏à‡∏≤‡∏Å SQL ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠: {title} (ID: {article_id})")
                deleted_articles.append((article_id,))
    if deleted_articles:
        cursor.executemany("DELETE FROM articles WHERE id=?", deleted_articles)
        conn.commit()
        cursor.execute("UPDATE sqlite_sequence SET seq = (SELECT COUNT(*) FROM articles) WHERE name = 'articles'")
        conn.commit()
    conn.close()

def cleanup_deleted_categories():
    """ ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô categories """
    conn = get_db_connection()
    if conn is None:
        return
    cursor = conn.cursor()

    # ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    cursor.execute("SELECT id, name, path FROM categories")
    categories = cursor.fetchall()

    deleted_categories = []
    for category in categories:
        category_id, category_name, category_path = category

        # ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if not os.path.exists(category_path):
            deleted_categories.append((category_id, category_name, category_path))

    if deleted_categories:
        print(f"üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {len(deleted_categories)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...")

        for category_id, category_name, category_path in deleted_categories:
            print(f"üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏≤‡∏Å SQL: {category_name} (Path: {category_path})")

            # ‚úÖ ‡∏•‡∏ö `articles` ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô
            cursor.execute("DELETE FROM articles WHERE category_id=?", (category_id,))

            # ‚úÖ ‡∏•‡∏ö `subcategories` ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ
            cursor.execute("DELETE FROM categories WHERE parent_id=?", (category_id,))

            # ‚úÖ ‡∏•‡∏ö `categories` ‡πÄ‡∏≠‡∏á
            cursor.execute("DELETE FROM categories WHERE id=?", (category_id,))
            conn.commit()

            log_message(f"üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß: {category_name}")

        # ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï `sqlite_sequence` ‡∏Ç‡∏≠‡∏á `categories`
        cursor.execute("UPDATE sqlite_sequence SET seq = (SELECT COUNT(*) FROM categories) WHERE name = 'categories'")
        conn.commit()

    # ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
    cursor.execute("SELECT COUNT(*) FROM categories")
    count_final = cursor.fetchone()[0]
    print(f"‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà: {count_final}")
    log_message(f"‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà: {count_final}")

    conn.close()

def load_data():
    """ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• """
    conn = get_db_connection()
    if conn is None:
        return
    cursor = conn.cursor()
    for category in os.listdir(DATA_DIR):
        category_path = os.path.join(DATA_DIR, category)
        if not os.path.isdir(category_path):
            continue
        cursor.execute("SELECT id FROM categories WHERE name=?", (category,))
        result = cursor.fetchone()
        category_id = result["id"] if result else None
        if category_id is None:
            cursor.execute("INSERT INTO categories (name, path, parent_id) VALUES (?, ?, ?)",
                           (category, category_path, None))
            category_id = cursor.lastrowid
        for subcategory in os.listdir(category_path):
            subcategory_path = os.path.join(category_path, subcategory)
            if not os.path.isdir(subcategory_path):
                continue
            cursor.execute("SELECT id FROM categories WHERE name=? AND parent_id=?", (subcategory, category_id))
            result = cursor.fetchone()
            subcategory_id = result["id"] if result else None
            if subcategory_id is None:
                cursor.execute("INSERT INTO categories (name, path, parent_id) VALUES (?, ?, ?)",
                               (subcategory, subcategory_path, category_id))
                subcategory_id = cursor.lastrowid
            for file in os.listdir(subcategory_path):
                ext = os.path.splitext(file)[-1].lower()
                if ext not in VALID_EXTENSIONS:
                    continue
                file_path = os.path.join(subcategory_path, file)
                title = os.path.splitext(file)[0]
                file_mtime = int(os.path.getmtime(file_path))
                if ext == ".docx":
                    doc = Document(file_path)
                    content = "\n".join([p.text for p in doc.paragraphs])
                elif ext in [".mp3", ".wav", ".ogg", ".mp4", ".mov"]:
                    content = f"media_file={file}"
                else:
                    with open(file_path, "r", encoding="utf-8", errors="replace") as f:
                        content = f.read()
                cursor.execute("SELECT id FROM articles WHERE title=? AND category_id=?", (title, subcategory_id))
                existing_article = cursor.fetchone()
                if existing_article:
                    cursor.execute("UPDATE articles SET content=?, updated_at=? WHERE id=?",
                                   (content, file_mtime, existing_article["id"]))
                else:
                    cursor.execute("INSERT INTO articles (title, content, category_id, updated_at) VALUES (?, ?, ?, ?)",
                                   (title, content, subcategory_id, file_mtime))
    conn.commit()
    conn.close()

# ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
ensure_tables_exist()
# ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
load_data()
# ‚úÖ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß
cleanup_deleted_files()
# ‚úÖ ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
cleanup_deleted_categories()

#database2.py
# lib/database.py
import sqlite3
from flask import g

DATABASE = 'blind_service.db'

def get_db():
    if 'db' not in g:
        g.db = sqlite3.connect(DATABASE)
        g.db.row_factory = sqlite3.Row
    return g.db

def close_db(e=None):
    db = g.pop('db', None)
    if db is not None:
        db.close()

def init_db(app):
    with app.app_context():
        db = get_db()
        cursor = db.cursor()
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                firstname TEXT NOT NULL,
                lastname TEXT NOT NULL,
                email TEXT NOT NULL UNIQUE,
                password TEXT NOT NULL,
                phone TEXT NOT NULL,
                address_permanent TEXT NOT NULL,
                address_current TEXT NOT NULL,
                dob DATE,
                profile_picture TEXT,
                rank TEXT NOT NULL DEFAULT 'user_default',
                registered_date DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        db.execute('''
            CREATE TABLE IF NOT EXISTS post_likes (
                user_id INTEGER,
                post_title TEXT,
                service_id INTEGER,
                is_like INTEGER,
                PRIMARY KEY (user_id, post_title, service_id)
            )
        ''')
        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö email ‡πÅ‡∏•‡∏∞ id
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_user_email ON users (email);")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_user_id ON users (id);")
        db.commit()

def update_user_rank(user_id, new_rank):
    db = get_db()
    db.execute("UPDATE users SET rank = ? WHERE id = ?", (new_rank, user_id))
    db.commit()

def update_user_rank_by_email(email, new_rank):
    user = get_user(email, by_email=True)
    if user:
        update_user_rank(user['id'], new_rank)
        return True
    return False

def get_user(identifier, by_email=False):
    db = get_db()
    cursor = db.cursor()
    if by_email:
        cursor.execute("SELECT * FROM users WHERE email = ?", (identifier,))
    else:
        cursor.execute("SELECT * FROM users WHERE id = ?", (identifier,))
    return cursor.fetchone()

def setup_app(app):
    with app.app_context():
        init_db(app)
        update_user_rank_by_email('arkarachaiwww123@gmail.com', 'user_administrator_and_manage_systems')

#home.py
from flask import Blueprint, render_template, session
import sqlite3
from lib.database import DB_FILE
import os
from lib.utils import get_greeting
from lib.auth import get_user

home_bp = Blueprint("home", __name__)
TITLE_FOLDER = "title"

@home_bp.route("/")
def home():
    """ ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• """
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # ‚úÖ ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î "h_" ‡∏≠‡∏≠‡∏Å
    cursor.execute("SELECT id, name FROM categories WHERE parent_id IS NULL")
    categories = {id: {"name": name[2:] if name.startswith("h_") else name, "subcategories": []} for id, name in cursor.fetchall()}

    # ‚úÖ ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô `categories`
    cursor.execute("SELECT id, name, parent_id FROM categories WHERE parent_id IS NOT NULL")
    for sub_id, sub_name, parent_id in cursor.fetchall():
        if parent_id in categories:
            categories[parent_id]["subcategories"].append((sub_id, sub_name))

    # ‚úÖ ‡∏î‡∏∂‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    cursor.execute("SELECT id, title FROM articles ORDER BY updated_at DESC LIMIT 5")
    latest_articles = cursor.fetchall()

    conn.close()

    # ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå 'title'
    title_contents = []
    if os.path.exists(TITLE_FOLDER):
        for filename in os.listdir(TITLE_FOLDER):
            if filename.endswith(".txt"):
                filepath = os.path.join(TITLE_FOLDER, filename)
                with open(filepath, "r", encoding="utf-8") as f:
                    content = f.read().strip().replace("\n", "<br>")
                    heading = os.path.splitext(filename)[0]
                    title_contents.append({"heading": heading, "content": content})

    greeting = get_greeting()  # ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
    user_id = session.get("user_id")
    user = get_user(user_id) if user_id else None

    return render_template(
        "index.html",
        greeting=greeting,
        user=user,
        categories=categories.items(),
        latest_articles=latest_articles,
        title_contents=title_contents
    )
#posts.py
# lib/posts.py
import os
from datetime import datetime
from flask import flash
from lib.database2 import get_user
from lib.service_centers import get_service_name, get_all_service_centers
from lib.utils import allowed_file, create_folder_if_not_exists  # ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ allowed_file ‡πÅ‡∏•‡∏∞ create_folder_if_not_exists

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏° ID ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
def create_service_folder(service_id, email=None):
    service_name = get_service_name(service_id)  
    folder_path = os.path.join('txt', service_name, email) if email else os.path.join('txt', service_name)
    create_folder_if_not_exists(folder_path)
    return folder_path

def handle_post(service_id, title, content, saved_images, firstname, lastname, user_rank, email):
    folder_path = create_service_folder(service_id, email)
    post_filepath = os.path.join(folder_path, f"{title}.txt")
    cleaned_content = content.strip().replace("\r\n", "\n")
    
    with open(post_filepath, 'w', encoding='utf-8') as f:
        f.write(f"‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢: {firstname} {lastname} ({user_rank})\n")
        f.write(f"‡πÄ‡∏ß‡∏•‡∏≤: {datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-4]}\n\n")
        if saved_images:
            f.write("‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤:\n")
            for image_name in saved_images:
                f.write(f"- {image_name}\n")
        f.write("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n")
        f.write(cleaned_content)
# ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
def get_posts(service_id):
    folder_path = create_service_folder(service_id)
    posts = []
    if not os.path.exists(folder_path):
        return posts

    for user_email in os.listdir(folder_path):
        user_folder_path = os.path.join(folder_path, user_email)
        if os.path.isdir(user_folder_path):
            for filename in os.listdir(user_folder_path):
                if filename.endswith('.txt') and not filename.endswith('_comment.txt'):
                    file_path = os.path.join(user_folder_path, filename)
                    content = read_post_content(file_path)
                    user = get_user(user_email, by_email=True)
                    
                    posts.append({
                        'title': filename[:-4],
                        'content': content,
                        'author': f"{user['firstname']} {user['lastname']}" if user else "Unknown",
                        'rank': user['rank'] if user else "Unknown",
                        'profile_picture': user['profile_picture'] if user else 'default_profile.png',
                        'date': os.path.getmtime(file_path)
                    })
    return sorted(posts, key=lambda x: x['date'], reverse=True)

# ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 5 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å
def read_post_content(file_path, limit_lines=False):
    with open(file_path, 'r', encoding='utf-8') as file:
        lines = file.readlines()
        
    post_time = lines[1].strip() if len(lines) > 1 else "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤"
    content = "".join(lines)
    details_index = content.find("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:")
    
    if details_index != -1:
        content = content[details_index + len("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:"):].strip()
    
    content = f"‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå: {post_time}<br><br>{content}"
    
    # ‡∏î‡∏∂‡∏á 5 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    return "<br>".join(content.split("<br>")[:5]) if limit_lines else content

# ‡∏î‡∏∂‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà 5 ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏£‡∏Å
def get_latest_posts():
    posts = []
    
    # Loop through all service centers (assuming service center folders exist)
    for service_id, service_name in get_all_service_centers().items():
        service_folder = create_service_folder(service_id)
        
        if not os.path.exists(service_folder):
            continue
        
        # Loop through all user folders
        for user_email in os.listdir(service_folder):
            user_folder = os.path.join(service_folder, user_email)
            
            if os.path.isdir(user_folder):
                # Loop through all post files in each user folder
                for filename in os.listdir(user_folder):
                    if filename.endswith('.txt') and not filename.endswith('_comment.txt'):
                        file_path = os.path.join(user_folder, filename)
                        content = read_post_content(file_path)
                        
                        # ‡∏î‡∏∂‡∏á‡πÅ‡∏Ñ‡πà 5 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                        first_5_lines = "<br>".join(content.splitlines()[:5])
                        
                        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ posts
                        posts.append({
                            'title': filename[:-4],  # ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢ .txt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
                            'content': first_5_lines,  # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 5 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å
                            'file_path': file_path,  # ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå
                            'service_id': service_id,
                        })
    
    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    sorted_posts = sorted(posts, key=lambda x: os.path.getmtime(x['file_path']), reverse=True)[:5]
    
    return sorted_posts

def get_post_images(post_id):
    post_folder = os.path.join('static', 'uploads', str(post_id))
    return [
        filename for filename in os.listdir(post_folder) if allowed_file(filename)
    ] if os.path.exists(post_folder) else []
#post_actions.py
# lib/post_actions.py
import os
from datetime import datetime
from flask import redirect, url_for, flash
from lib.database2 import get_user  # ‡πÉ‡∏ä‡πâ get_user ‡πÅ‡∏ó‡∏ô get_user_by_email
from lib.service_centers import get_service_name  # Import service name function
from flask import session, request, jsonify
from lib.database2 import get_db

# Function to log actions into log.txt
def log_action(action, details=""):
    with open('log.txt', 'a', encoding='utf-8') as log_file:
        log_file.write(f"{datetime.now()} - {action}: {details}\n")

# Check if the user is the post owner
def check_post_owner(service_id, post_title, email):
    if email is None:
        log_action("Email not provided", "Failed to check post ownership")
        return False

    service_name = get_service_name(service_id)  # Get service name using the centralized function
    post_folder = os.path.join('txt', service_name, email)
    post_filepath = os.path.join(post_folder, f"{post_title}.txt")
    return os.path.exists(post_filepath)

# Save comments to a file
def save_comment(service_id, post_title, comment_content, firstname, lastname, user_email, post_owner_email):
    service_name = get_service_name(service_id)
    post_folder = os.path.join('txt', service_name, post_owner_email)
    
    if not os.path.exists(post_folder):
        os.makedirs(post_folder)

    comment_filename = f"{post_title}_comment.txt"
    comment_filepath = os.path.join(post_folder, comment_filename)

    comment_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-4]

    # Save the comment with email for easy profile picture lookup
    with open(comment_filepath, 'a', encoding='utf-8') as f:
        f.write(f"{firstname} {lastname} ({user_email}):{comment_content}:{comment_time}\n")

# Fetch the post content and associated comments
def get_post_and_comments(service_id, post_title, post_owner_email):
    service_name = get_service_name(service_id)
    post_folder = os.path.join('txt', service_name, post_owner_email)

    if not os.path.exists(post_folder):
        return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå", []

    post_filepath = os.path.join(post_folder, f"{post_title}.txt")
    if not os.path.exists(post_filepath):
        return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå", []

    post_content = read_post_content(post_filepath)
    comments = []
    comment_filepath = os.path.join(post_folder, f"{post_title}_comment.txt")

    if os.path.exists(comment_filepath):
        with open(comment_filepath, 'r', encoding='utf-8') as f:
            lines = f.readlines()
            for line in lines:
                parsed = line.strip().split(':', 2)
                if len(parsed) == 3:
                    author_info, content, timestamp = parsed
                    # ‡∏î‡∏∂‡∏á user_id ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                    email = author_info.split("(")[-1].strip(")")
                    user = get_user(email, by_email=True)
                    if user:
                        profile_picture = user['profile_picture']
                        user_id = user['id']
                    else:
                        profile_picture = 'default_profile.png'
                        user_id = None
                    
                    comments.append({
                        'author': author_info,
                        'content': content,
                        'user_id': user_id,  # ‡πÉ‡∏ä‡πâ user_id ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                        'time': timestamp,
                        'profile_picture': profile_picture
                    })

    return post_content, comments

def read_post_content(file_path):
    with open(file_path, 'r', encoding='utf-8') as file:
        lines = file.readlines()
    
    content = "".join(lines)
    details_index = content.find("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:")
    if details_index != -1:
        content = content[details_index + len("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:"):].strip()

    return content

def get_post_owner_email(service_id, post_title):
    service_name = get_service_name(service_id)
    service_folder = os.path.join('txt', service_name)

    for user_email in os.listdir(service_folder):
        user_folder = os.path.join(service_folder, user_email)
        if os.path.isdir(user_folder):
            post_filepath = os.path.join(user_folder, f"{post_title}.txt")
            if os.path.exists(post_filepath):
                log_action("Post owner found", f"Owner: {user_email}")
                return user_email

    log_action("Post owner not found", f"Service ID: {service_id}, Post Title: {post_title}")
    return None

# Function to delete a comment
def delete_comment(service_id, post_title, comment_author, comment_time, user_email):
    service_name = get_service_name(service_id)
    comment_filepath = os.path.join('txt', service_name, user_email, f"{post_title}_comment.txt")

    if not os.path.exists(comment_filepath):
        log_action("Comment file not found", comment_filepath)
        return False

    updated_comments = []
    with open(comment_filepath, 'r', encoding='utf-8') as f:
        lines = f.readlines()
        for line in lines:
            parsed = line.strip().split(":", 2)
            if len(parsed) == 3 and (parsed[0] != comment_author or parsed[2] != comment_time):
                updated_comments.append(line)

    with open(comment_filepath, 'w', encoding='utf-8') as f:
        f.writelines(updated_comments)

    log_action("Comment deleted", f"Service ID: {service_id}, Post Title: {post_title}, Author: {comment_author}, Comment Time: {comment_time}")
    return True

# Function to edit a comment
def edit_comment(service_id, post_title, comment_author, comment_time, new_content, user_email):
    service_name = get_service_name(service_id)
    comment_filepath = os.path.join('txt', service_name, user_email, f"{post_title}_comment.txt")

    if not os.path.exists(comment_filepath):
        log_action("Comment file not found", comment_filepath)
        return False

    updated_comments = []
    with open(comment_filepath, 'r', encoding='utf-8') as f:
        lines = f.readlines()
        for line in lines:
            parsed = line.strip().split(":", 2)
            if len(parsed) == 3 and parsed[0] == comment_author and parsed[2] == comment_time:
                updated_comments.append(f"{parsed[0]}:{new_content}:{parsed[2]}\n")
            else:
                updated_comments.append(line)

    with open(comment_filepath, 'w', encoding='utf-8') as f:
        f.writelines(updated_comments)

    log_action("Comment edited", f"Service ID: {service_id}, Post Title: {post_title}, Author: {comment_author}, Comment Time: {comment_time}")
    return True

from flask import jsonify

def like_post():
    if 'user_id' not in session:
        return jsonify({'error': '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'}), 403

    user_id = session['user_id']
    data = request.json
    post_title = data['post_title']
    service_id = data['service_id']
    is_like = data['is_like']

    with get_db() as conn:  # Using context manager for the connection
        cursor = conn.cursor()

        cursor.execute("""
            INSERT INTO post_likes (user_id, post_title, service_id, is_like)
            VALUES (?, ?, ?, ?)
            ON CONFLICT(user_id, post_title, service_id)
            DO UPDATE SET is_like=excluded.is_like
        """, (user_id, post_title, service_id, is_like))
        conn.commit()

        # Get the latest like/dislike count
        like_count = cursor.execute("SELECT COUNT(*) FROM post_likes WHERE post_title=? AND service_id=? AND is_like=1", (post_title, service_id)).fetchone()[0]
        dislike_count = cursor.execute("SELECT COUNT(*) FROM post_likes WHERE post_title=? AND service_id=? AND is_like=0", (post_title, service_id)).fetchone()[0]

    return jsonify({'likes': like_count, 'dislikes': dislike_count})

def get_post_like_counts(service_id, post_title):
    with get_db() as conn:  # Using context manager for the connection
        cursor = conn.cursor()

        likes = cursor.execute("SELECT COUNT(*) FROM post_likes WHERE post_title=? AND service_id=? AND is_like=1", (post_title, service_id)).fetchone()[0]
        dislikes = cursor.execute("SELECT COUNT(*) FROM post_likes WHERE post_title=? AND service_id=? AND is_like=0", (post_title, service_id)).fetchone()[0]

    return likes, dislikes

#search.py
from flask import Blueprint, render_template, request
from lib.database import get_db_connection

search_bp = Blueprint("search", __name__)

@search_bp.route("/search", methods=["GET"])
def search():
    query = request.args.get("q", "").strip()

    if not query:
        return render_template("search.html", query=query, results=[])

    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("""
        SELECT id, title, content FROM articles
        WHERE title LIKE ? OR content LIKE ?
    """, (f"%{query}%", f"%{query}%"))

    results = cursor.fetchall()
    conn.close()

    return render_template("search.html", query=query, results=results)

#service.py
import sqlite3
from datetime import datetime
from flask import Blueprint, render_template
from lib.database import DB_FILE

service_bp = Blueprint("service", __name__)

@service_bp.route("/service/<int:category_id>")
def service(category_id):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    cursor.execute("SELECT name FROM categories WHERE id=?", (category_id,))
    category_name = cursor.fetchone()[0]

    cursor.execute("SELECT id, name FROM categories WHERE parent_id=?", (category_id,))
    subcategories = cursor.fetchall()

    cursor.execute("SELECT id, title, updated_at FROM articles WHERE category_id=?", (category_id,))
    articles = cursor.fetchall()

    conn.close()
    return render_template("service.html", category_name=category_name, subcategories=subcategories, articles=articles)

#service_centers.py
# lib/service_centers.py
SERVICE_CENTERS = {
    1: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢',
    2: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠'
}

def get_all_service_centers():
    # Return all service centers
    return SERVICE_CENTERS

def get_service_name(service_id):
    # Return the name of a specific service center by its ID
    return SERVICE_CENTERS.get(service_id, f"‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ {service_id}")

import os

def get_service_intro(service_name):
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á path ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
    filename = f"title_{service_name}.txt"
    file_path = os.path.join('txt', service_name, filename)

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    if os.path.exists(file_path):
        with open(file_path, 'r', encoding='utf-8') as f:
            return f.read().strip()  # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ (‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á)
    else:
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
        return "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö"


#user_management.py
#lib.user_management.py
from flask import flash, session, redirect, url_for
from lib.database2 import get_db

def promote_user_to_admin(user_id):
    db = get_db()
    db.execute("UPDATE users SET rank = 'user_admin' WHERE id = ?", (user_id,))
    db.commit()
    flash('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')

def demote_user_to_default(user_id):
    db = get_db()
    db.execute("UPDATE users SET rank = 'user_default' WHERE id = ?", (user_id,))
    db.commit()
    flash('‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')

def get_user_details(user_id):
    db = get_db()
    return db.execute("SELECT * FROM users WHERE id = ?", (user_id,)).fetchone()

def get_all_users():
    db = get_db()
    return db.execute("SELECT * FROM users").fetchall()

#utils.py
#lib.utiles.py
import os
from flask import session, flash, redirect, url_for
from werkzeug.utils import secure_filename
from lib.database2 import get_user

def get_greeting():
    if 'user_id' in session and session.get('user_id'):  
        user = get_user(session['user_id'])
        if user:
            rank = user['rank']
            first_name, last_name = user['firstname'], user['lastname']
            if rank == 'user_default':
                return f"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {first_name} {last_name} (User default)"
            elif rank == 'user_admin':
                return f"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {first_name} {last_name} (User admin)"
            elif rank == 'user_administrator_and_manage_systems':
                return f"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {first_name} {last_name} (System Manager)"
    return "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"


def check_user_rank(user_rank, required_rank):
    if user_rank != required_rank:
        flash('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')
        return redirect(url_for('index'))
    return None

def create_folder_if_not_exists(folder_path):
    if not os.path.exists(folder_path):
        os.makedirs(folder_path)

ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif'}

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def save_image(image, folder):
    filename = secure_filename(image.filename)
    filepath = os.path.join(folder, filename)
    image.save(filepath)
    return filename

def sanitize_filename(name):
    import re
    return re.sub(r'[\\/:"*?<>|]+', "", name).strip()

#404.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤</title>
</head>
<body>
    <h1>404 - ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
    <p>‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤</p>
    <a href="{{ url_for('home.home') }}">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
</body>
</html>

#500.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</title>
</head>
<body>
    <h1>500 - ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h1>
    <p>‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
    <a href="{{ url_for('home.home') }}">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
</body>
</html>

#account.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</title>
</head>
<body>
<a href="/" accesskey="h" title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

    <div class="container">
        <h1>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
        <p>‡∏ä‡∏∑‡πà‡∏≠: {{ user['firstname'] }} {{ user['lastname'] }}</p>
        <p>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: {{ user['email'] }}</p>
        <p>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: {{ user['phone'] }}</p>
        <p>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô: {{ user['address_permanent'] }}</p>
        <p>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {{ user['address_current'] }}</p>
        <p>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î: {{ user['dob'] }}</p>

        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ -->
        {% if user['profile_picture'] %}
        <p>‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå:</p>
        <img src="{{ url_for('static', filename='uploads/' + user['profile_picture']) }}" alt="Profile Picture" width="150">
        {% endif %}

        <a href="{{ url_for('account.edit_account') }}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
        <a href="{{ url_for('logout') }}">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>

    </div>
</body>
</html>

#add_article.html
{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</h2>
    <form method="POST" action="{{ url_for('add_article') }}">
        <div class="mb-3">
            <label for="title" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</label>
            <input type="text" class="form-control" id="title" name="title" required>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label>
            <textarea class="form-control" id="content" name="content" rows="8" required></textarea>
        </div>
        <div class="mb-3">
            <label for="category_id" class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <select class="form-select" id="category_id" name="category_id" required>
                {% for id, name in categories %}
                <option value="{{ id }}">{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-success">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</button>
    </form>
</div>
{% endblock %}

#admin.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Admin - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</title>
</head>
<body>
<a href="/" accesskey="h" title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

    <div class="container">
      <h1>Admin - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</h1>
      <form action="/post_update" method="POST">
          <label for="content">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤:</label><br>
          <textarea id="content" name="content" rows="5" cols="50"></textarea><br>
          <button type="submit">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
      </form>
    </div>
</body>
</html>

#admin_dashboard.html
{% extends "base.html" %}

{% block title %}‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•{% endblock %}

{% block content %}
<h2 class="text-primary">üõ† ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
<hr>
<a href="{{ url_for('add_article') }}" class="btn btn-outline-success btn-sm">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</a>

<h4>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</h4>
<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>‡πÑ‡∏≠‡∏î‡∏µ</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</th>
            <th>‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á</th>
        </tr>
    </thead>
    <tbody>
        {% for article in articles %}
        <tr>
            <td>{{ article.id }}</td>
            <td>{{ article.title }}</td>
            <td>
                {% if article.tts_exists %}
                    ‚úÖ
                {% else %}
                    ‚ùå
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

#base.html
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f6f9;
    }
    .info-topbar {
      background: #f8f9fa;
      border-bottom: 1px solid #ccc;
      padding: 10px 20px;
      font-size: 0.9rem;
    }
    .user-profile {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 5px;
    }
  </style>
  {% block head_extra %}{% endblock %}
</head>
<body>

<!-- Greeting + Clock -->
<div class="info-topbar text-center">
  <div id="clockbox" class="mb-1 text-muted">üïì</div>
  <div id="greetingbox" class="mb-1">üëã</div>

  {% if user %}
    <div class="text-dark mb-1">
      {% if user.profile_picture %}
        <img src="{{ url_for('static', filename='uploads/' ~ user.profile_picture) }}" class="user-profile" alt="profile">
      {% endif %}
      üë§ {{ user.firstname }} {{ user.lastname }} ({{ user.rank }})
    </div>
  {% else %}
    <div class="text-danger mb-1">üîí ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
  {% endif %}
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="{{ url_for('home.home') }}">‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMain">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('index2') }}">‡∏ü‡∏≠‡∏£‡∏±‡πà‡∏°</a></li>
        {% if 'user_id' in session %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('account') }}">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a></li>
          {% if user.rank == 'user_administrator_and_manage_systems' %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('manage_users') }}">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_dashboard') }}">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</a></li>
          {% elif user.rank == 'user_admin' %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_dashboard') }}">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</a></li>
          {% endif %}
          <li class="nav-item"><a class="nav-link text-warning" href="{{ url_for('logout') }}">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('register') }}">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- Hero Section -->
<div class="bg-light py-4 shadow-sm border-bottom">
  <div class="container text-center">
    <h1 class="text-primary">üìå ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤: {{ self.title() | safe }}</h1>

    {% block page_description %}{% endblock %}

    <!-- Search Bar -->
    <div class="row justify-content-center mt-4">
      <div class="col-md-8 col-lg-6">
        <form class="d-flex" action="{{ url_for('search.search') }}" method="GET">
          <input class="form-control me-2" type="search" name="q" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°..." aria-label="Search">
          <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container mt-4">
  {% block content %}{% endblock %}
</div>

<!-- Footer -->
<footer class="text-center mt-5 bg-dark text-white py-3">
  <p>¬© 2025 ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì | <a href="#" class="text-light">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a></p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const tday = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  const tmonth = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  function GetClock() {
    const d = new Date();
    let nhour = d.getHours();
    const nmin = d.getMinutes().toString().padStart(2, '0');
    const nsec = d.getSeconds().toString().padStart(2, '0');
    const ap = nhour < 12 ? " AM" : " PM";
    if (nhour === 0) nhour = 12;
    else if (nhour > 12) nhour -= 12;
    const timeString = `${tday[d.getDay()]}, ${tmonth[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()} ${nhour}:${nmin}:${nsec}${ap}`;
    document.getElementById('clockbox').innerHTML = timeString;
    let greeting;
    if (d.getHours() < 12) greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏öüôè";
    else if (d.getHours() === 12) greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡∏öüôè";
    else if (d.getHours() >= 13 && d.getHours() <= 17) greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢üôè";
    else greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ôüôè";
    document.getElementById('greetingbox').innerHTML = greeting;
    setTimeout(GetClock, 1000);
  }
  window.onload = GetClock;
</script>
</body>
</html>

#content.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        img { max-width: 100%; height: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        table, th, td { border: 1px solid black; padding: 8px; text-align: left; }
        pre { white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('home.home') }}">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    </div>
</nav>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home.home') }}">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
        </ol>
    </nav>
</div>

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <h1 class="card-title text-primary">{{ title }}</h1>
            <hr>

            {% if content.startswith("media_file=") %}
                {% set media_file = content.split("=")[1].strip() %}
                {% set media_url = url_for('media_file', filename=media_file) %}
                <p><strong>URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå:</strong> <a href="{{ media_url }}" target="_blank">{{ media_url }}</a></p>
                {% set ext = media_file.split('.')[-1].lower() %}

                {% if ext in ["mp3", "wav", "ogg"] %}
                    <audio id="media_player" controls preload="metadata">
                        <source src="{{ media_url }}" type="audio/{{ ext }}">
                        ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                    </audio>
                {% elif ext in ["mp4", "mov"] %}
                    <video id="media_player" width="600" controls>
                        <source src="{{ media_url }}" type="video/{{ ext }}">
                        ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                    </video>
                {% endif %}
            {% else %}
                <div class="card-text">{{ content | safe }}</div>

                <!-- üîä ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö TTS -->
                <div class="d-flex justify-content-center mt-4">
                    {% if tts_url %}
                        <div class="text-center">
                            <h5>üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</h5>
                            <audio id="tts_audio" controls>
                                <source src="{{ tts_url }}" type="audio/mpeg">
                                ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ
                            </audio>
                            <script>
                                const audio = document.getElementById("tts_audio");
                                audio.playbackRate = 1.5;  // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (1.0 = ‡∏õ‡∏Å‡∏ï‡∏¥, 1.2 = ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á)
                            </script>
                        </div>
                    {% else %}
                        <form action="{{ url_for('content.generate_tts', article_id=article_id) }}" method="get">
                            <button type="submit" class="btn btn-primary">üîä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                        </form>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<button onclick="topFunction()" id="backToTop" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-3" style="display: none;">‚¨Ü</button>

<footer class="bg-dark text-white text-center py-3 mt-5">
    <p>¬© 2025 ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let backToTopButton = document.getElementById("backToTop");
    window.onscroll = function() {
        backToTopButton.style.display = (document.documentElement.scrollTop > 200) ? "block" : "none";
    };
    function topFunction() {
        document.documentElement.scrollTop = 0;
    }
</script>
</body>
</html>

#edit_account.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</title>
</head>
<body>
<a href="/" accesskey="h" title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

    <div class="container">
        <h1>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h1>
        <form action="{{ url_for('account.edit_account') }}" method="POST" enctype="multipart/form-data">
            <label for="firstname">‡∏ä‡∏∑‡πà‡∏≠:</label>
            <input type="text" name="firstname" value="{{ user['firstname'] }}" required>
            
            <label for="lastname">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
            <input type="text" name="lastname" value="{{ user['lastname'] }}" required>

            <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
            <input type="email" name="email" value="{{ user['email'] }}" required>

            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
            <input type="text" name="phone" value="{{ user['phone'] }}" required>

            <label for="address_permanent">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô:</label>
            <input type="text" name="address_permanent" value="{{ user['address_permanent'] }}" required>

            <label for="address_current">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
            <input type="text" name="address_current" value="{{ user['address_current'] }}" required>

            <label for="dob">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î:</label>
            <input type="date" name="dob" value="{{ user['dob'] }}" required>

            <label for="profile_picture">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà:</label>
            <input type="file" name="profile_picture" accept="image/*">

            <input type="submit" value="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
        </form>

        <a href="{{ url_for('account.account') }}">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
    </div>
</body>
</html>

#edit_post.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>edit post</title>
</head>
<body>
<a href="/" accesskey="h" title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

    <div class="container">
  <h1>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå: {{ post_title }}</h1>
  <form method="POST">
      <textarea name="new_content" required>{{ post_content }}</textarea>
      <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  </form>
    </div>
</body>
</html>

#index.html
{% extends "base.html" %}

{% block title %}‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å{% endblock %}
{% block page_heading %}‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å{% endblock %}

{% block content %}
<!-- ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡πà‡∏ô -->
{% if title_contents %}
<div class="container mt-5">
    <h2 class="text-center text-success">üåü </h2>
    <div class="row">
        {% for item in title_contents %}
        <div class="col-md-12 mb-4">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <h3 class="text-success"><i class="fa-solid fa-star text-warning"></i> {{ item.heading }}</h3>
                    <p class="text-dark fs-5" style="line-height: 1.6;">{{ item.content | safe }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å -->
<div class="container mt-5">
    <h2 class="text-center text-primary">üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å</h2>
    <div class="row">
        {% for category_id, category_data in categories %}
        <div class="col-md-4 mb-3">
            <div class="card category-card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">{{ category_data["name"] }}</h5>
                    {% if category_data["subcategories"] %}
                    <ul class="list-group">
                        {% for sub_id, sub_name in category_data["subcategories"] %}
                        <li class="list-group-item">
                            <a href="{{ url_for('service.service', category_id=sub_id) }}" class="text-decoration-none">
                                <i class="fas fa-folder"></i> {{ sub_name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡πà‡∏≠‡∏¢</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ‚úÖ ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
<div class="container mt-5">
    <h2 class="text-center text-secondary">üì∞ ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
    <ul class="list-group">
        {% for id, title in latest_articles %}
        <li class="list-group-item">
            <a href="{{ url_for('content.content', article_id=id) }}" class="text-decoration-none">
                <i class="fas fa-file-alt"></i> {{ title }}
            </a>
        </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

#index2.html
{% extends "base.html" %}

{% block title %}Forum{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-primary">üì¢ Forum</h1>
    <div id="greetingbox" class="my-2"></div>

<div class="container mt-4">
    <h2>üìå ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà Forum</h2>
    <ul class="list-group list-group-flush">
        {% for service_id, service_name in service_centers.items() %}
            <li class="list-group-item">
                <a href="{{ url_for('service_center', service_id=service_id) }}">
                    üóÇÔ∏è {{ service_name }}
                </a>
            </li>
        {% endfor %}
    </ul>
</div>

<div class="container mt-5">
    <h2>‚≠ê ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h2>
    <ul class="list-group">
        {% for post in latest_posts %}
            <li class="list-group-item">
                <h5>{{ post.title }}</h5>
                <div style="white-space: pre-line;">{{ post.content|safe }}</div>

                {% if post_images[post.title] %}
                    <div class="post-images mt-2 mb-2">
                        {% for image in post_images[post.title] %}
                            <img src="{{ url_for('static', filename='uploads/' + post.title + '/' + image) }}" alt="Post Image" width="150px" class="me-2 mb-2 rounded">
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏ö</p>
                {% endif %}

                <a href="{{ url_for('post_actions', service_id=post.service_id, post_title=post.title) }}" class="btn btn-sm btn-outline-primary">‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠</a>
            </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
    const tday = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const tmonth = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    function GetClock() {
        const d = new Date();
        let nhour = d.getHours();
        const nmin = d.getMinutes().toString().padStart(2, '0');
        const nsec = d.getSeconds().toString().padStart(2, '0');
        const ap = nhour < 12 ? " AM" : " PM";

        if (nhour === 0) nhour = 12;
        else if (nhour > 12) nhour -= 12;

        const timeString = `${tday[d.getDay()]}, ${tmonth[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()} ${nhour}:${nmin}:${nsec}${ap}`;
        document.getElementById('clockbox').innerHTML = timeString;

        let greeting;
        if (d.getHours() < 12) greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏öüôè";
        else if (d.getHours() === 12) greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡∏öüôè";
        else if (d.getHours() >= 13 && d.getHours() <= 17) greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢üôè";
        else greeting = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ôüôè";
        document.getElementById('greetingbox').innerHTML = greeting;

        setTimeout(GetClock, 1000);
    }
    window.onload = GetClock;
</script>
{% endblock %}

#login.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</title>
</head>
<body>
<a href="/" accesskey="h" title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

  <div class="container">
    <a href="/" accesskey="h"title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>
    <h1>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
    <form method="POST" action="{{ url_for('login') }}">
        <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label><br>
        <input type="email" id="email" name="email" required><br><br>
        <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label><br>
        <input type="password" id="password" name="password" required><br><br>
        <button type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <p>‡∏´‡∏£‡∏∑‡∏≠</>
        <a href="{{ url_for('register') }}"><button>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button></a>
    </form>
  </div>
</body>
</html>

#manage_users.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>
</head>
<body>
<a href="/" accesskey="h" title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

  <div class="container">
    <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1>
    <p><a href="{{ url_for('home.home') }}">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></p>

    <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <table>
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user.firstname }} {{ user.lastname }}</td>
                    <td>
                        <a href="{{ url_for('user_details', id=user.id) }}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
  </div>
</body>
</html>

#post_actions.html
{% extends "base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå - {{ post_title }}{% endblock %}

{% block content %}
<a href="{{ url_for('home.home') }}" class="btn btn-outline-secondary mb-3">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>

<div class="card mb-4">
    <div class="card-body">
        <h3 class="card-title">
            <img src="{{ url_for('static', filename='uploads/' + post_owner_profile_picture) }}"
                 class="rounded-circle me-2" width="50" height="50" alt="Profile Picture">
            {{ post_title }}
        </h3>
        <div id="post-content" class="card-text mt-3"></div>
    </div>
</div>

<script>
    const rawContent = `{{ post_content | e }}`;
    document.getElementById('post-content').innerHTML = rawContent.replace(/\n/g, '<br>');
</script>

{% if post_images %}
<div class="image-grid mb-4">
    {% for image_file in post_images %}
        <img src="{{ url_for('static', filename='uploads/' + post_title + '/' + image_file) }}"
             alt="Attached Image" class="img-thumbnail">
    {% endfor %}
</div>
{% endif %}

<div class="like-buttons mt-2" data-post-title="{{ post_title }}" data-service-id="{{ service_id }}">
    <button class="btn btn-outline-success btn-sm like-btn">üëç ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</button>
    <span class="like-count">0</span>
    <button class="btn btn-outline-danger btn-sm dislike-btn ms-2">üëé ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</button>
    <span class="dislike-count">0</span>
</div>

<!-- ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå -->
<div class="mt-3">
  <button class="btn btn-info" onclick="sharePost()">üîó ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
</div>

<script>
  function sharePost() {
    const link = window.location.href;
    navigator.clipboard.writeText(link).then(() => {
      alert("üìé ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
    });
  }
</script>


<!-- üîΩ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå -->
<div class="card mb-4">
    <div class="card-header bg-light">
        üí¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </div>
    <div class="card-body">
        {% if comments %}
            {% for comment in comments %}
                <div class="border-bottom pb-3 mb-3">
                    <img src="{{ url_for('static', filename='uploads/' + comment.profile_picture) }}"
                         alt="Profile Picture" class="rounded-circle me-2" width="40" height="40">
                    <strong>{{ comment.author }}</strong> <br>
                    <small class="text-muted">üïí {{ comment.time }}</small>
                    <p class="mt-2">{{ comment.content }}</p>

                    {% if 'user_id' in session and user.rank != 'user_default' %}
                        <a href="{{ url_for('user_details', id=comment.user_id) }}" class="btn btn-link btn-sm">‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
                    {% endif %}

                    {% if user and comment.author == user.firstname + ' ' + user.lastname %}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary me-1"
                                    onclick="toggleEditForm('edit-form-{{ loop.index }}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <form action="{{ url_for('delete_comment', service_id=service_id, post_title=post_title, comment_time=comment.time) }}"
                                  method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger">‡∏•‡∏ö</button>
                            </form>

                            <form id="edit-form-{{ loop.index }}"
                                  action="{{ url_for('edit_comment', service_id=service_id, post_title=post_title, comment_time=comment.time) }}"
                                  method="POST" class="mt-2" style="display: none;">
                                <textarea name="new_content" class="form-control mb-2">{{ comment.content }}</textarea>
                                <button type="submit" class="btn btn-sm btn-success">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</p>
        {% endif %}
    </div>
</div>

<!-- üîΩ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà -->
<div class="card mb-5">
    <div class="card-header bg-light">‚úçÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</div>
    <div class="card-body">
        <form action="{{ url_for('post_actions', service_id=service_id, post_title=post_title) }}" method="POST">
            <textarea name="comment" class="form-control mb-2" rows="4" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." required></textarea>
            <button type="submit" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</button>
        </form>
    </div>
</div>

<!-- üîΩ ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå -->
{% if is_owner %}
    <div class="d-flex justify-content-between align-items-center mb-5">
        <a href="{{ url_for('edit_post', service_id=service_id, post_title=post_title) }}"
           class="btn btn-warning">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå</a>

        <form action="{{ url_for('delete_post', service_id=service_id, post_title=post_title) }}" method="POST">
            <button type="submit" class="btn btn-danger">üóëÔ∏è ‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
        </form>
    </div>
{% endif %}

<style>
.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
}
.image-grid img {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: 8px;
}
</style>

<script>
function toggleEditForm(formId) {
    const form = document.getElementById(formId);
    form.style.display = (form.style.display === "none" || !form.style.display) ? "block" : "none";
}
</script>

<script>
document.querySelectorAll('.like-buttons').forEach(group => {
    const post_title = group.dataset.postTitle;
    const service_id = group.dataset.serviceId;
    const likeBtn = group.querySelector('.like-btn');
    const dislikeBtn = group.querySelector('.dislike-btn');
    const likeCount = group.querySelector('.like-count');
    const dislikeCount = group.querySelector('.dislike-count');

    function sendLike(is_like) {
        fetch('/like_post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ post_title, service_id, is_like })
        })
        .then(res => res.json())
        .then(data => {
            likeCount.textContent = data.likes;
            dislikeCount.textContent = data.dislikes;
        });
    }

    likeBtn.addEventListener('click', () => sendLike(true));
    dislikeBtn.addEventListener('click', () => sendLike(false));
});
</script>

{% endblock %}

#register.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
</head>
<body>
    <a href="/" accesskey="h"title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

    <div class="container">
        <h1>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h1>
<form action="{{ url_for('register') }}" method="POST" enctype="multipart/form-data">
    <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á -->
    <label for="firstname">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á:</label>
    <input type="text" name="firstname" id="firstname" required>

    <!-- ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• -->
    <label for="lastname">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
    <input type="text" name="lastname" id="lastname" required>

    <!-- ‡∏≠‡∏µ‡πÄ‡∏°‡∏• -->
    <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
    <input type="email" name="email" id="email" required>

    <!-- ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
    <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
    <input type="password" name="password" id="password" required>

    <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå -->
    <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
    <input type="text" name="phone" id="phone" required>

    <!-- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏≤‡∏ß‡∏£ -->
    <label for="address_permanent">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏≤‡∏ß‡∏£:</label>
    <input type="text" name="address_permanent" id="address_permanent" required>

    <!-- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
    <label for="address_current">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
    <input type="text" name="address_current" id="address_current" required>

    <!-- ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î -->
    <label for="dob">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î:</label>
    <input type="date" name="dob" id="dob" required>

    <!-- ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
    <label for="profile_picture">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå:</label>
    <input type="file" name="profile_picture" accept="image/*" required>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° -->
    <input type="submit" value="‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">
</form>

    </div>
</body>
</html>

#search.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ - {{ query }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h2 class="text-primary">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: "{{ query }}"</h2>
    <hr>

    {% if results %}
        <ul class="list-group">
            {% for article in results %}
                <li class="list-group-item">
                    <a href="{{ url_for('content.content', article_id=article['id']) }}">
                        <h5 class="mb-1">{{ article['title'] }}</h5>
                    </a>
                    <p class="mb-0">{{ article['content'][:100] }}...</p>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>
    {% endif %}
</div>

</body>
</html>

#service.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>{{ category_name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <h1 class="text-primary">{{ category_name }}</h1>

        <h2>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡πà‡∏≠‡∏¢</h2>
        <ul class="list-group">
            {% for id, name in subcategories %}
                <li class="list-group-item">
                    <a href="{{ url_for('service', category_id=id) }}" class="text-decoration-none">
                        <i class="fas fa-folder"></i> {{ name }}
                    </a>
                </li>
            {% endfor %}
        </ul>

        <h2 class="mt-4">‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
        <ul class="list-group">
            {% for id, title, updated_at in articles %}
                <li class="list-group-item">
                    <a href="{{ url_for('content.content', article_id=id) }}" class="text-decoration-none">
                        <i class="fas fa-file-alt"></i> {{ title }}
                    </a>
                    <br>
                    <small class="text-muted updated-time" data-time="{{ updated_at }}">üìÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</small>
                </li>
            {% endfor %}
        </ul>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".updated-time").forEach(function(el) {
            let rawTime = el.getAttribute("data-time");

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Timestamp (Unix Time) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô String (YYYY-MM-DD HH:MM:SS)
            let timestamp;
            if (!isNaN(rawTime) && rawTime.length >= 10) {
                timestamp = parseInt(rawTime) * 1000; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Unix Time ‚Üí ‡∏Ñ‡∏π‡∏ì 1000 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô milliseconds
            } else {
                timestamp = Date.parse(rawTime); // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö String ‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Timestamp
            }

            if (!isNaN(timestamp)) {
                let dateObj = new Date(timestamp);

                let options = { 
                    year: "numeric", 
                    month: "long", 
                    day: "numeric",
                    hour: "2-digit", 
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: false
                };

                let formattedDate = new Intl.DateTimeFormat("th-TH", options).format(dateObj);
                el.innerText = `üìÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formattedDate}`;
            } else {
                el.innerText = "üìÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ";
            }
        });
    });
    </script>

</body>
</html>

#service_center.html
{% extends "base.html" %}

{% block title %}{{ service_name }} - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£{% endblock %}

{% block content %}
<h1 class="mb-3 text-primary">üìç ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤: {{ service_name }}</h1>
<div id="clockbox" class="mb-3 fw-bold"></div>

<script>
    const tday = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const tmonth = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    function GetClock() {
        const d = new Date();
        let nhour = d.getHours();
        const nmin = d.getMinutes().toString().padStart(2, '0');
        const nsec = d.getSeconds().toString().padStart(2, '0');
        const ap = nhour < 12 ? " AM" : " PM";
        if (nhour === 0) nhour = 12;
        else if (nhour > 12) nhour -= 12;
        document.getElementById('clockbox').innerHTML = `${tday[d.getDay()]}, ${tmonth[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()} ${nhour}:${nmin}:${nsec}${ap}`;
        setTimeout(GetClock, 1000);
    }
    window.onload = GetClock;
</script>

{% if greeting %}
    <div class="alert alert-info">
        {{ greeting }}
        {% if greeting == "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" %}
            <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm ms-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
            <a href="{{ url_for('register') }}" class="btn btn-outline-secondary btn-sm ms-1">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
        {% else %}
            <a href="{{ url_for('account') }}" class="btn btn-success btn-sm ms-2">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
            {% if 'user_id' in session and user.rank == 'user_administrator_and_manage_systems' %}
                <a href="{{ url_for('manage_users') }}" class="btn btn-warning btn-sm ms-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a>
            {% endif %}
        {% endif %}
    </div>
{% endif %}

<div class="card mb-4">
    <div class="card-header bg-light">
        üìù ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢
    </div>
    <div class="card-body">
        <form action="{{ url_for('post_service_center', service_id=service_id) }}" method="POST" enctype="multipart/form-data">
            <label for="title" class="form-label">‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:</label>
            <input type="text" id="title" name="title" class="form-control" required>

            <label for="content" class="form-label mt-3">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤:</label>
            <textarea id="content" name="content" rows="4" class="form-control" required></textarea>

            <label for="image" class="form-label mt-3">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
            <input type="file" id="image" name="image" class="form-control" multiple>

            <button type="submit" class="btn btn-primary mt-3">üì® ‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
        </form>
    </div>
</div>

<div class="mb-4">
    <h2 class="text-success">üìò ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
    <p>{{ service_intro }}</p>
</div>

<h2 class="text-secondary mb-3">üìÇ ‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
{% for post in posts %}
    <div class="post-container">
        <h4>
            <img src="{{ url_for('static', filename='uploads/' + post.profile_picture) }}"
                 alt="Profile" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
            {{ post.title }}
        </h4>
        <p class="text-muted">üßë ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢: {{ post.author }} (‡∏£‡∏∞‡∏î‡∏±‡∏ö: {{ post.rank }})</p>
        <div class="mb-2" style="white-space: pre-line;">{{ post.content|safe }}</div>

        {% if post_images[post.title] %}
            <div class="mb-2">
                <p class="mb-1">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö:</p>
                {% for image_file in post_images[post.title] %}
                    <img src="{{ url_for('static', filename='uploads/' + post.title + '/' + image_file) }}"
                         alt="Attached Image" class="img-thumbnail me-2" style="max-width: 300px;">
                {% endfor %}
            </div>
        {% endif %}
        <a href="{{ url_for('post_actions', service_id=service_id, post_title=post.title) }}" class="btn btn-outline-primary btn-sm">üìñ ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠</a>
    </div>
{% endfor %}
{% endblock %}

#signup.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</title>
</head>
<body>
    <h1>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h1>
    <form action="/submit_signup" method="POST">
        <label for="firstname">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á:</label>
        <input type="text" id="firstname" name="firstname" required><br>

        <label for="lastname">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
        <input type="text" id="lastname" name="lastname" required><br>

        <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
        <input type="email" id="email" name="email" required><br>

        <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
        <input type="password" id="password" name="password" required><br>

        <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
        <input type="tel" id="phone" name="phone" required><br>

        <label for="home_address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô:</label><br>
        <textarea id="home_address" name="home_address" rows="3" required></textarea><br>

        <label for="current_address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label><br>
        <textarea id="current_address" name="current_address" rows="3" required></textarea><br>

        <button type="submit">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
    </form>
</body>
</html>

#user_details.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>
</head>
<body>
<a href="/" accesskey="h" title="Clear [Alt+H]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Home)</a>

  <div class="container">
    <h1>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1>
    <p><a href="{{ url_for('manage_users') }}">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a></p>

    <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á {{ user.firstname }} {{ user.lastname }}</h2>
    <p>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: {{ user.email }}</p>
    <p>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: {{ user.phone }}</p>
    <p>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô: {{ user.address_permanent }}</p>
    <p>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {{ user.address_current }}</p>
    <p>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î: {{ user.dob }}</p>
    <p>‡∏£‡∏∞‡∏î‡∏±‡∏ö: {{ user.rank }}</p>
    <p>‡∏ß‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: {{ user.registered_date }}</p>

    <h3>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
    <form method="POST">
        <select name="rank">
            <option value="user_default" {% if user.rank == 'user_default' %}selected{% endif %}>User Default</option>
            <option value="user_admin" {% if user.rank == 'user_admin' %}selected{% endif %}>User Admin</option>
        </select>
        <button type="submit">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö</button>
    </form>
  </div>
</body>
</html>

